name: Xserver VPS Renewal

on:
  schedule:
    - cron: '45 0 * * *'   # 每天UTC时间00:45（日本时间09:45）
  workflow_dispatch:       # 支持手动触发

jobs:
  renew:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install system dependencies
        run: |
          sudo apt-get -qq update
          sudo apt-get -yqq install --no-install-recommends \
            ffmpeg \
            fonts-noto-cjk \
            xvfb

      - name: Install project dependencies
        run: yarn install

      - name: Run renewal script
        id: renewal-script
        env:
          EMAIL: ${{ secrets.EMAIL }}
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          echo "开始执行续订脚本（日本时间 09:45）"
          node main.mjs

      - name: Upload recording
        uses: actions/upload-artifact@v4
        with:
          name: recording-0945
          path: recording.webm

      - name: Upload error screenshot
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-screenshot-0945
          path: error.png

      - name: Send ServerChan notification
        id: serverchan
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.SERVER_CHAN_SENDKEY }}
          message: |
            ${{ steps.renewal-script.outcome == 'success' && '✅ Xserver VPS 续订成功！' || '❌ Xserver VPS 续订失败！' }}
            
            执行时间: 09:45 JST
            运行状态: ${{ steps.renewal-script.outcome }}
            工作流程ID: ${{ github.run_id }}
            运行详情: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ${{ failure() && '⚠️ 错误截图已上传至Artifacts，请及时处理！' || '🎉 VPS服务已成功续订！' }}
          format: html
        env:
          TELEGRAM_TOKEN: "dummy"
