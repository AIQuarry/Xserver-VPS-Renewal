name: Xserver VPS Renewal

on:
  schedule:
    # æ¯å¤© UTC 00:45ï¼ˆæ—¥æœ¬æ—¶é—´ 09:45ï¼‰
    - cron: '45 0 * * *'
  workflow_dispatch:

jobs:
  renew:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ‹‰å–ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2ï¸âƒ£ å®‰è£… Node.jsï¼Œå¹¶è‡ªåŠ¨å¯ç”¨ Corepackï¼ˆå†…ç½® yarnï¼‰
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: |
            yarn
          cache-dependency-path: |
            yarn.lock   # ä»…å½“å­˜åœ¨ yarn.lock æ—¶å¯ç”¨ç¼“å­˜

      # 3ï¸âƒ£ å®‰è£…ç³»ç»Ÿä¾èµ– + JS ä¾èµ–
      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -yqq --no-install-recommends \
            fonts-noto-cjk \
            xvfb
          corepack enable
          yarn install --immutable

      # 4ï¸âƒ£ è¿è¡Œç»­è®¢è„šæœ¬
      - name: Run renewal script
        id: renewal
        env:
          EMAIL: ${{ secrets.EMAIL }}
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          echo "ğŸ“¢ å¼€å§‹æ‰§è¡Œç»­è®¢è„šæœ¬..."
          node main.mjs

      # 5ï¸âƒ£ ä»…åœ¨å¤±è´¥æ—¶ä¸Šä¼ æˆªå›¾ï¼ˆè‹¥æˆªå›¾æ–‡ä»¶ä¸å­˜åœ¨åˆ™å¿½ç•¥ï¼‰
      - name: Upload error screenshot
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-screenshot
          path: error.png
          if-no-files-found: ignore

      # 6ï¸âƒ£ Serveré…±é€šçŸ¥ï¼ˆæ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¼šå‘é€ï¼‰
      - name: Notify via Serveré…±
        if: always()
        env:
          SENDKEY: ${{ secrets.SERVER_CHAN_SENDKEY }}
          RESULT: ${{ steps.renewal.outcome }}
          RUN_URL: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        run: |
          TITLE=$(printf "Xserver VPS ç»­è®¢ %s" "$( [ "$RESULT" = "success" ] && echo æˆåŠŸ || echo å¤±è´¥ )")
          DESP=$(printf "çŠ¶æ€: %s\næ—¶é—´: %s\næ—¥å¿—: %s" \
            "$RESULT" \
            "$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S')" \
            "$RUN_URL")

          # URL-encodeå¹¶å‘é€
          api="https://sctapi.ftqq.com/${SENDKEY}.send"
          curl -G --data-urlencode "title=${TITLE}" --data-urlencode "desp=${DESP}" "$api"
