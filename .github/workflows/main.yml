name: Xserver VPS Renewal

on:
  schedule:
    - cron: '45 0 * * *'  # 每天 UTC 00:45，对应日本时间 09:45
  workflow_dispatch:

jobs:
  renew:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -yqq --no-install-recommends \
            fonts-noto-cjk \
            xvfb
          yarn install

      - name: Run renewal script
        id: renewal
        env:
          EMAIL: ${{ secrets.EMAIL }}
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          echo "开始执行续订脚本..."
          node main.mjs

      - name: Upload error screenshot (if failed)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-screenshot
          path: error.png

      - name: Notify via Server酱
        if: always()
        run: |
          TITLE="Xserver VPS 续订 ${{ steps.renewal.outcome == 'success' && '成功' || '失败' }}"
          STATUS="状态: ${{ steps.renewal.outcome }}"
          TIME="时间: $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S')"
          LINK="查看日志：https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -X POST "https://sctapi.ftqq.com/${{ secrets.SERVER_CHAN_SENDKEY }}.send" \
            -d "title=$TITLE" \
            -d "desp=$STATUS%0A$TIME%0A$LINK"
