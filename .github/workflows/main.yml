name: Xserver VPS Renewal

on:
  schedule:
    - cron: '0 0 * * *'   # æ¯å¤©UTCæ—¶é—´00:00è§¦å‘ï¼ˆæ—¥æœ¬æ—¶é—´09:00ï¼‰
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  renew:
    runs-on: ubuntu-latest
    steps:
      - name: Calculate random execution time
        id: random-time
        run: |
          # è®¡ç®—æ—¥æœ¬æ—¶é—´07:00åˆ°23:00ä¹‹é—´çš„éšæœºåˆ†é’Ÿæ•°ï¼ˆ420-1380åˆ†é’Ÿï¼‰
          min_minutes=420   # 07:00 JST = 22:00 UTC (å‰ä¸€å¤©)
          max_minutes=1380  # 23:00 JST = 14:00 UTC
          
          # ç”Ÿæˆéšæœºåˆ†é’Ÿæ•° (420-1380)
          random_minutes=$(( RANDOM % (max_minutes - min_minutes + 1) + min_minutes ))
          
          # è®¡ç®—å»¶è¿Ÿç§’æ•°
          delay_seconds=$(( random_minutes * 60 ))
          
          # è½¬æ¢ä¸ºå¯è¯»æ—¶é—´æ ¼å¼
          random_hour=$(( random_minutes / 60 ))
          random_minute=$(( random_minutes % 60 ))
          jst_time=$(printf "%02d:%02d" $random_hour $random_minute)
          
          echo "éšæœºæ‰§è¡Œæ—¶é—´ï¼šæ—¥æœ¬æ—¶é—´ $jst_time"
          echo "delay_seconds=$delay_seconds" >> $GITHUB_OUTPUT
          echo "jst_time=$jst_time" >> $GITHUB_OUTPUT

      - name: Wait for random time
        uses: juliangruber/sleep-action@v1.0.0
        with:
          time: ${{ steps.random-time.outputs.delay_seconds }}s

      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install system dependencies
        run: |
          sudo apt-get -qq update
          sudo apt-get -yqq install --no-install-recommends \
            ffmpeg \
            fonts-noto-cjk \
            xvfb

      - name: Install project dependencies
        run: yarn install

      - name: Run renewal script
        id: renewal-script
        env:
          EMAIL: ${{ secrets.EMAIL }}
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          echo "å¼€å§‹æ‰§è¡Œç»­è®¢è„šæœ¬ï¼ˆé¢„å®šæ—¶é—´ï¼š${{ steps.random-time.outputs.jst_time }} JSTï¼‰"
          node main.mjs

      - name: Upload recording
        uses: actions/upload-artifact@v4
        with:
          name: recording-${{ steps.random-time.outputs.jst_time }}
          path: recording.webm

      - name: Upload error screenshot
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-screenshot-${{ steps.random-time.outputs.jst_time }}
          path: error.png

      - name: Send ServerChan notification
        id: serverchan
        if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½å‘é€é€šçŸ¥
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.SERVER_CHAN_SENDKEY }}
          message: |
            ${{ steps.renewal-script.outcome == 'success' && 'âœ… Xserver VPS ç»­è®¢æˆåŠŸï¼' || 'âŒ Xserver VPS ç»­è®¢å¤±è´¥ï¼' }}
            
            **æ‰§è¡Œæ—¶é—´**: ${{ steps.random-time.outputs.jst_time }} JST
            **è¿è¡ŒçŠ¶æ€**: ${{ steps.renewal-script.outcome }}
            **å·¥ä½œæµç¨‹ID**: ${{ github.run_id }}
            **è¿è¡Œè¯¦æƒ…**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ${{ failure() && 'âš ï¸ é”™è¯¯æˆªå›¾å·²ä¸Šä¼ è‡³Artifactsï¼Œè¯·åŠæ—¶å¤„ç†ï¼' || 'ğŸ‰ VPSæœåŠ¡å·²æˆåŠŸç»­è®¢ï¼' }}
          format: html
        env:
          TELEGRAM_TOKEN: "dummy"  # ServerChanä¸éœ€è¦tokenï¼Œä½†actionéœ€è¦æ­¤å˜é‡
