name: Xserver VPS Renewal

on:
  schedule:
    - cron: '45 0 * * *'   # æ¯å¤©UTCæ—¶é—´00:45ï¼ˆæ—¥æœ¬æ—¶é—´09:45ï¼‰
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  renew:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install system dependencies
        run: |
          sudo apt-get -qq update
          sudo apt-get -yqq install --no-install-recommends \
            ffmpeg \
            fonts-noto-cjk \
            xvfb

      - name: Install project dependencies
        run: yarn install

      - name: Run renewal script
        id: renewal-script
        env:
          EMAIL: ${{ secrets.EMAIL }}
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          echo "å¼€å§‹æ‰§è¡Œç»­è®¢è„šæœ¬ï¼ˆæ—¥æœ¬æ—¶é—´ 09:45ï¼‰"
          node main.mjs

      - name: Upload recording
        uses: actions/upload-artifact@v4
        with:
          name: recording-0945
          path: recording.webm

      - name: Upload error screenshot
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-screenshot-0945
          path: error.png

      - name: Send ServerChan notification
        id: serverchan
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.SERVER_CHAN_SENDKEY }}
          message: |
            ${{ steps.renewal-script.outcome == 'success' && 'âœ… Xserver VPS ç»­è®¢æˆåŠŸï¼' || 'âŒ Xserver VPS ç»­è®¢å¤±è´¥ï¼' }}
            
            æ‰§è¡Œæ—¶é—´: 09:45 JST
            è¿è¡ŒçŠ¶æ€: ${{ steps.renewal-script.outcome }}
            å·¥ä½œæµç¨‹ID: ${{ github.run_id }}
            è¿è¡Œè¯¦æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ${{ failure() && 'âš ï¸ é”™è¯¯æˆªå›¾å·²ä¸Šä¼ è‡³Artifactsï¼Œè¯·åŠæ—¶å¤„ç†ï¼' || 'ğŸ‰ VPSæœåŠ¡å·²æˆåŠŸç»­è®¢ï¼' }}
          format: html
        env:
          TELEGRAM_TOKEN: "dummy"
